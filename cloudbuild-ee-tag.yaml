steps:
- name: 'gcr.io/cloud-builders/npm'
  dir: /workspace/api
  args: ["install"]

- name: 'gcr.io/cloud-builders/npm'
  dir: /workspace/api
  args: ["run", "test"]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "build",  "-t", "botfront-local", "."]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "build", "-t", "botfront-api-local", "./api"]

- name: 'gcr.io/kaniko-project/executor:latest'
  dir: /workspace/botfront/cypress
  args:
  - --dockerfile=Dockerfile_cypress
  - --context=/workspace/botfront/cypress
  - --destination=gcr.io/$PROJECT_ID/cypress-runner:latest
  - --cache=true
  - --cache-ttl=24h

- name: gcr.io/$PROJECT_ID/docker-compose
  dir: /workspace/botfront/cypress
  args:
    - up
    - --abort-on-container-exit
    - --exit-code-from
    - e2e

- name: 'gcr.io/cloud-builders/npm'
  dir: './botfront'
  args: [ "run",  "docs:build"]

- name: 'gcr.io/cloud-builders/docker'
  args:
    [
      "build",
      "-t",
      "gcr.io/${PROJECT_ID}/botfront-docs:$TAG_NAME",
      "-t",
      "gcr.io/${PROJECT_ID}/botfront-docs:latest",
      "./botfront/docs",
    ]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "tag", "botfront-local", "gcr.io/${PROJECT_ID}/botfront:latest"]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "tag", "botfront-local", "gcr.io/${PROJECT_ID}/botfront:$TAG_NAME"]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "tag", "botfront-api-local", "gcr.io/${PROJECT_ID}/botfront-api:$TAG_NAME"]

- name: 'gcr.io/cloud-builders/docker'
  args: [ "tag", "botfront-api-local", "gcr.io/${PROJECT_ID}/botfront-api:latest"]

# - name: 'gcr.io/cloud-builders/kubectl'
#   args:
#   - set
#   - image
#   - deployment
#   - botfront
#   - botfront=gcr.io/${PROJECT_ID}/botfront:$TAG_NAME
#   - --namespace
#   - ${_NAMESPACE}
#   env:
#   - 'CLOUDSDK_COMPUTE_ZONE=${_COMPUTE_ZONE}'
#   - 'CLOUDSDK_CONTAINER_CLUSTER=${_CONTAINER_CLUSTER}'

images:
- "gcr.io/${PROJECT_ID}/botfront:latest"
- "gcr.io/${PROJECT_ID}/botfront:$TAG_NAME"
- "gcr.io/${PROJECT_ID}/botfront-docs:latest"
- "gcr.io/${PROJECT_ID}/botfront-docs:$TAG_NAME"
- "gcr.io/${PROJECT_ID}/botfront-api:latest"
- "gcr.io/${PROJECT_ID}/botfront-api:$TAG_NAME"

timeout: 60m
options:
    machineType: 'N1_HIGHCPU_8'